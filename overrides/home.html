<!-- Custom HTML site displayed as the Home chapter -->
{% extends "main.html" %}


<!-- Custom styles for the home site -->
{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ base_url }}/{{ 'assets/stylesheets/home.css' | url }}" />
    <link rel="stylesheet" href="{{ base_url }}/{{ 'assets/stylesheets/particles.css' | url }}" />
    <link rel="stylesheet" href="{{ base_url }}/{{ 'assets/stylesheets/gallery_home.css' | url }}" />
    <link rel="stylesheet" href="{{ base_url }}/{{ 'assets/stylesheets/filter_menu.css' | url }}" />
  <link rel="stylesheet" href="{{ base_url }}/{{ 'assets/stylesheets/home_footer.css' | url }}" />
    <script src="{{ base_url }}/{{ 'assets/javascripts/cards_menu.js' | url }}"></script>
{% endblock %}


<!-- Custom javascript for the home site -->
{% block libs %}
    {{ super() }}
    <script src="{{ base_url }}/{{ 'assets/javascripts/particles.js' | url }}"></script>
    <script>
        particlesJS.load('particles-js', 'assets/javascripts/particles.json', function() {
            console.log('particles.js loaded - callback');
        });
    </script>
    <script src="assets/javascripts/extra.js"></scriptsrc>></script>
{% endblock %}


{# ----------  Hero Section  ---------- #}
{% block tabs %}
  {{ super() }}
  {% include "partials/hero.html" %}
{% endblock %}


{% block container %}
  {{ super() }}
{% endblock %}

{% block content %}
  {{ super() }}
  <section class="gallery-wrapper">
    <div id="filterMenu"></div>
    <div id="gallery-home"></div>

    <script type="module">
    import { Gallery } from '/assets/javascripts/components/GalleryHome.js';
    import { FilterMenu } from '/assets/javascripts/components/FilterMenu.js';
    import { LazyLoader } from '/assets/javascripts/components/LazyLoader.js';
    const categories = [
      'All',
      'Articles',
      'Case studies',
      'Projects',
      'Resources',
      'Notebooks'
    ];
    const gallery = new Gallery('#gallery-home', '/assets/publications.json');
    let lazyLoader = null;
    let filterMenu = null;

    function computeCounts(items) {
      const counts = { All: items.length };
      for (const cat of categories) {
        if (cat === 'All') continue;
        if (cat === 'Articles') {
          counts[cat] = items.filter(i => i.category === 'references' && i.src && i.src.includes('/articles/')).length;
        } else if (cat === 'Case studies') {
          counts[cat] = items.filter(i => i.category === 'references' && i.src && i.src.includes('/case-studies/')).length;
        } else {
          // Map UI label to data category
          const map = {
            'Notebooks': 'notebooks',
            'Projects': 'projects',
            'Resources': 'resources',
          };
          counts[cat] = items.filter(i => i.category === map[cat]).length;
        }
      }
      return counts;
    }

    async function startLazyLoader() {
      if (!gallery.filteredItems.length) return;
      if (lazyLoader) lazyLoader.destroy();
      gallery.container.innerHTML = '';
      lazyLoader = new LazyLoader({
        container: gallery.container,
        items: gallery.filteredItems,
        batchSize: 8,
        renderFn: items => gallery.renderItems(items, { append: true })
      });
      lazyLoader.init();
    }

    gallery.init().then(() => {
      // Compute counts from allItems
      const counts = computeCounts(gallery.allItems);
      filterMenu = new FilterMenu('#filterMenu', categories, cat => {
        gallery.setFilter(cat);
        startLazyLoader();
        // Update counts for filtered set if needed (optional)
      }, counts);
      startLazyLoader();
    });
    </script>
  </section>
{% endblock %}