{# Home page template #}
{% extends "main.html" %}

{# Styles specific to the home page #}
{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ base_url }}/{{ 'assets/stylesheets/home.css' | url }}" />
  <link rel="stylesheet" href="{{ base_url }}/{{ 'assets/stylesheets/particles.css' | url }}" />
  <link rel="stylesheet" href="{{ base_url }}/{{ 'assets/stylesheets/gallery_home.css' | url }}" />
  <link rel="stylesheet" href="{{ base_url }}/{{ 'assets/stylesheets/filter_menu.css' | url }}" />
  <link rel="stylesheet" href="{{ base_url }}/{{ 'assets/stylesheets/home_footer.css' | url }}" />
{% endblock %}

{# Libraries and page-level scripts #}
{% block libs %}
  {{ super() }}
  <script src="{{ base_url }}/{{ 'assets/javascripts/particles.js' | url }}"></script>
  <script>
    // Initialize particles once DOM and target container are available
    document.addEventListener('DOMContentLoaded', function () {
      const targetId = 'particles-js';
      const cfgPath = "{{ base_url }}/{{ 'assets/javascripts/particles.json' | url }}";
      function initParticles() {
        const el = document.getElementById(targetId);
        if (!el) { requestAnimationFrame(initParticles); return; }
        if (window.particlesJS?.load) {
          window.particlesJS.load(targetId, cfgPath);
        }
      }
      initParticles();
    });
  </script>
  <script src="{{ base_url }}/{{ 'assets/javascripts/extra.js' | url }}"></script>
{% endblock %}

{# Hero section (title + particles background) #}
{% block tabs %}
  {{ super() }}
  {% include "partials/hero.html" %}
{% endblock %}

{# Main content: filter + gallery #}
{% block content %}
  {{ super() }}
  <section class="gallery-home-wrapper">
    <div id="filterMenu"></div>
    <div id="gallery-home"></div>

    <script type="module">
      // Use base_url-aware module paths to work under subpaths
      import { Gallery } from "{{ base_url }}/assets/javascripts/components/GalleryHome.js";
      import { FilterMenu } from "{{ base_url }}/assets/javascripts/components/FilterMenu.js";
      import { LazyLoader } from "{{ base_url }}/assets/javascripts/components/LazyLoader.js";

      const categories = ['All','Articles','Case studies','Projects','Resources','Notebooks'];
      const gallery = new Gallery('#gallery-home', '{{ base_url }}/assets/publications.json');
      let lazyLoader = null;

      function computeCounts(items) {
        const counts = { All: items.length };
        for (const cat of categories) {
          if (cat === 'All') continue;
          if (cat === 'Articles') {
            counts[cat] = items.filter(i => i.category === 'references' && i.src?.includes('/articles/')).length;
          } else if (cat === 'Case studies') {
            counts[cat] = items.filter(i => i.category === 'references' && i.src?.includes('/case-studies/')).length;
          } else {
            const map = { 'Notebooks': 'notebooks', 'Projects': 'projects', 'Resources': 'resources' };
            counts[cat] = items.filter(i => i.category === map[cat]).length;
          }
        }
        return counts;
      }

      async function startLazyLoader() {
        if (!gallery.filteredItems.length) return;
        if (lazyLoader) lazyLoader.destroy();
        gallery.container.innerHTML = '';
        lazyLoader = new LazyLoader({
          container: gallery.container,
          items: gallery.filteredItems,
          batchSize: 8,
          renderFn: items => gallery.renderItems(items, { append: true })
        });
        lazyLoader.init();
      }

      gallery.init().then(() => {
        const counts = computeCounts(gallery.allItems);
        new FilterMenu('#filterMenu', categories, (cat) => {
          gallery.setFilter(cat);
          startLazyLoader();
        }, counts);
        startLazyLoader();
      });
    </script>
  </section>
{% endblock %}
